#!/usr/bin/env bash
# Compare bundler vs scint install times (cold + warm) for a project.
# Delegates scint runs to scint-test-and-report; bundler is timed inline.
#
# Usage:
#   bin/scint-vs-bundler [--force] [/path/to/project]

set -euo pipefail

FORCE=0
PROJECT=""

usage() {
  cat <<'USAGE'
Usage: bin/scint-vs-bundler [--force] [/path/to/project]

Options:
  --force     Rebuild bundler baseline even if cached
  -h, --help  Show help
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --force)  FORCE=1; shift ;;
    -h|--help) usage; exit 0 ;;
    -*) echo "Unknown option: $1" >&2; usage; exit 2 ;;
    *)
      if [[ -n "$PROJECT" ]]; then
        echo "Unexpected argument: $1" >&2; usage; exit 2
      fi
      PROJECT="$1"; shift ;;
  esac
done

PROJECT="${PROJECT:-$PWD}"
PROJECT="$(cd "$PROJECT" && pwd)"
BASENAME="$(basename "$PROJECT")"
PROJECT_SLUG="$(echo "$BASENAME" | tr -c 'A-Za-z0-9._-' '_')"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPORT="$SCRIPT_DIR/scint-test-and-report"

if [[ ! -x "$REPORT" ]]; then
  echo "scint-test-and-report not found: $REPORT" >&2; exit 1
fi
if [[ ! -f "$PROJECT/Gemfile" || ! -f "$PROJECT/Gemfile.lock" ]]; then
  echo "Project needs Gemfile + Gemfile.lock: $PROJECT" >&2; exit 1
fi

RUNS_ROOT="/tmp/scint-runs"
BUNDLER_DIR="$RUNS_ROOT/$PROJECT_SLUG/bundler"
SYSTEM_GEM_DIR="$(ruby -e 'puts Gem.default_dir')"

# ── helper: timed bundler install ────────────────────────────────
run_bundler() {
  local label="$1" dest="$2" log="$3"
  echo ""
  echo "── $label ──"
  local start end_t elapsed
  start=$(ruby -e 'puts Process.clock_gettime(Process::CLOCK_MONOTONIC)')
  set +e
  (cd "$PROJECT" && \
    env BUNDLE_PATH="$dest" \
        GEM_HOME="$BUNDLER_DIR/gem-home" \
        GEM_PATH="$BUNDLER_DIR/gem-home:$SYSTEM_GEM_DIR" \
        BUNDLE_DISABLE_SHARED_GEMS=1 \
    bundle install --jobs=8 \
  ) > "$log" 2>&1
  local rc=$?
  set -e
  end_t=$(ruby -e 'puts Process.clock_gettime(Process::CLOCK_MONOTONIC)')
  elapsed=$(ruby -e "puts (($end_t - $start)).round(3)")
  echo "  ${elapsed}s (rc=$rc)"
  echo "$elapsed" > "$log.time"
  echo "$rc" > "$log.rc"
}

# ── bundler cold + warm ─────────────────────────────────────────
bundler_ready=0
if [[ -f "$BUNDLER_DIR/cold.log.time" && -f "$BUNDLER_DIR/warm.log.time" ]]; then
  bundler_ready=1
fi
if [[ "$FORCE" -eq 1 ]]; then
  rm -rf "$BUNDLER_DIR"
  bundler_ready=0
fi

if [[ "$bundler_ready" -eq 0 ]]; then
  mkdir -p "$BUNDLER_DIR"
  run_bundler "bundler install (cold)" "$BUNDLER_DIR/cold-bundle" "$BUNDLER_DIR/cold.log"
  run_bundler "bundler install (warm)" "$BUNDLER_DIR/warm-bundle" "$BUNDLER_DIR/warm.log"
else
  echo "Reusing cached bundler baseline at: $BUNDLER_DIR"
fi

bc=$(cat "$BUNDLER_DIR/cold.log.time")
bw=$(cat "$BUNDLER_DIR/warm.log.time")
bc_rc=$(cat "$BUNDLER_DIR/cold.log.rc")
bw_rc=$(cat "$BUNDLER_DIR/warm.log.rc")

# ── scint cold + warm (via scint-test-and-report) ────────────────
echo ""
"$REPORT" --clean-all "$PROJECT"
echo ""
"$REPORT" "$PROJECT"

# ── read scint timings from JSONL ────────────────────────────────
TIMINGS="$RUNS_ROOT/timings.jsonl"

read -r sc sc_rc < <(tail -n2 "$TIMINGS" | head -1 | ruby -rjson -e 'r=JSON.parse(STDIN.read); puts "#{r["install_seconds"]} #{r["install_rc"]}"')
read -r sw sw_rc < <(tail -n1 "$TIMINGS" | ruby -rjson -e 'r=JSON.parse(STDIN.read); puts "#{r["install_seconds"]} #{r["install_rc"]}"')

# ── comparison table ─────────────────────────────────────────────
echo ""
echo "╔══════════════════════════════════════════╗"
echo "║  Comparison: $BASENAME"
echo "╚══════════════════════════════════════════╝"
echo ""

ruby -e '
  bc, bw, sc, sw = ARGV[0..3].map(&:to_f)
  bc_rc, bw_rc, sc_rc, sw_rc = ARGV[4..7].map(&:to_i)

  fmt = lambda { |s|
    if s < 60
      t = format("%.1f", s).sub(/\.0\z/, "")
      "#{t}s"
    else
      m = (s / 60).floor
      r = s - m * 60
      "#{m}m #{format("%.1f", r).sub(/\.0\z/, "")}s"
    end
  }

  rel = lambda { |phase, baseline|
    return "n/a" if baseline <= 0
    x = baseline / phase
    x >= 1.0 ? "#{format("%.2f", x)}x faster" : "#{format("%.2f", 1.0/x)}x slower"
  }

  rc_mark = lambda { |code| code == 0 ? "ok" : "FAIL (rc=#{code})" }

  rows = [
    ["Bundler cold", fmt.call(bc), "baseline",          rc_mark.call(bc_rc)],
    ["Bundler warm", fmt.call(bw), rel.call(bw, bc),    rc_mark.call(bw_rc)],
    ["Scint cold",   fmt.call(sc), rel.call(sc, bc),    rc_mark.call(sc_rc)],
    ["Scint warm",   fmt.call(sw), rel.call(sw, bc),    rc_mark.call(sw_rc)],
  ]

  puts "  %-16s %10s  %-20s %s" % ["Phase", "Time", "vs Bundler Cold", "Status"]
  puts "  " + "-" * 64
  rows.each { |r| puts "  %-16s %10s  %-20s %s" % r }
  puts ""
' "$bc" "$bw" "$sc" "$sw" "$bc_rc" "$bw_rc" "$sc_rc" "$sw_rc"
