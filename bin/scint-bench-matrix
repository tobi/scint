#!/usr/bin/env bash
# Run scint-vs-bundler across all project subdirectories under --root.
#
# Usage:
#   bin/scint-bench-matrix [--root PATH] [--projects a,b,c] [--skip-invalid] [--force]

set -euo pipefail

ROOT="$PWD"
FORCE=0
SKIP_INVALID=0
PROJECT_FILTER=""

usage() {
  cat <<'USAGE'
Usage: bin/scint-bench-matrix [options]

Options:
  --root PATH         Root containing project subdirectories (default: cwd)
  --projects a,b,c    Restrict to specific subdirectory names
  --force             Rebuild bundler baselines
  --skip-invalid      Skip subdirs missing Gemfile/Gemfile.lock
  -h, --help          Show help
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --root)          ROOT="${2:-}"; shift 2 ;;
    --projects)      PROJECT_FILTER="${2:-}"; shift 2 ;;
    --force)         FORCE=1; shift ;;
    --skip-invalid)  SKIP_INVALID=1; shift ;;
    -h|--help)       usage; exit 0 ;;
    *)               echo "Unknown option: $1" >&2; usage; exit 2 ;;
  esac
done

ROOT="$(cd "$ROOT" && pwd)"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VS_TOOL="$SCRIPT_DIR/scint-vs-bundler"

if [[ ! -x "$VS_TOOL" ]]; then
  echo "scint-vs-bundler not found: $VS_TOOL" >&2; exit 1
fi

# ── collect projects ─────────────────────────────────────────────
declare -a projects=()
if [[ -n "$PROJECT_FILTER" ]]; then
  IFS=',' read -r -a projects <<< "$PROJECT_FILTER"
else
  for dir in "$ROOT"/*/; do
    [[ -d "$dir" ]] || continue
    projects+=("$(basename "$dir")")
  done
fi

echo "Root:     $ROOT"
echo "Projects: ${projects[*]}"
echo ""

# ── run each project ─────────────────────────────────────────────
declare -a passed=()
declare -a failed=()
declare -a skipped=()

for project in "${projects[@]}"; do
  project="${project// /}"
  [[ -z "$project" ]] && continue

  dir="$ROOT/$project"
  if [[ ! -f "$dir/Gemfile" || ! -f "$dir/Gemfile.lock" ]]; then
    if [[ "$SKIP_INVALID" -eq 1 ]]; then
      echo "[SKIP] $project (missing Gemfile or Gemfile.lock)"
      skipped+=("$project")
      continue
    else
      echo "[INVALID] $project (missing Gemfile or Gemfile.lock)" >&2
      failed+=("$project")
      continue
    fi
  fi

  echo ""
  echo "════════════════════════════════════════"
  echo "  $project"
  echo "════════════════════════════════════════"

  cmd=("$VS_TOOL")
  [[ "$FORCE" -eq 1 ]] && cmd+=("--force")
  cmd+=("$dir")

  set +e
  "${cmd[@]}"
  rc=$?
  set -e

  if [[ "$rc" -eq 0 ]]; then
    passed+=("$project")
  else
    failed+=("$project")
  fi
done

# ── summary ──────────────────────────────────────────────────────
TIMINGS="/tmp/scint-runs/timings.jsonl"

echo ""
echo "╔══════════════════════════════════════════╗"
echo "║  Matrix Summary                          ║"
echo "╚══════════════════════════════════════════╝"
echo ""
echo "  Passed:  ${#passed[@]}  ${passed[*]:-}"
echo "  Failed:  ${#failed[@]}  ${failed[*]:-}"
echo "  Skipped: ${#skipped[@]}  ${skipped[*]:-}"
echo ""

if [[ -f "$TIMINGS" ]]; then
  echo "  All timing history:"
  echo "    $TIMINGS"
  echo ""
  cat "$TIMINGS" | ruby -rjson -e '
    STDIN.each_line do |l|
      r = JSON.parse(l)
      printf "    %-14s %-6s %6.1fs  gems=%-3d compiled=%-3d  setup=%d install=%d test=%d\n",
        r["project"], r["run_kind"], r["install_seconds"],
        r["gems_total"], r["gems_compiled"],
        r["setup_rc"], r["install_rc"], r["test_rc"]
    end
  '
fi

[[ ${#failed[@]} -eq 0 ]]
